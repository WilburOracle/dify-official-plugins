#!/bin/bash

set -x

# Get script directory more robustly
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."

# Get the path argument if provided
PATH_TO_CHECK="$1"

# Check if uv is available, otherwise use python -m pip and python -m basedpyright
if command -v uv &> /dev/null; then
    echo "Using uv for dependency management..."
    # Ensure development dependencies are installed
    echo "Installing/checking development dependencies..."
    uv sync --group dev
    
    # run basedpyright checks
    if [ -n "$PATH_TO_CHECK" ]; then
        echo "Running basedpyright on: $PATH_TO_CHECK"
        uv run --group dev basedpyright "$PATH_TO_CHECK"
    else
        echo "Running basedpyright on entire repository..."
        uv run --group dev basedpyright
    fi
else
    echo "uv not found, using python..."
    # Check if basedpyright is installed
    if ! python3 -m basedpyright --version &> /dev/null; then
        echo "basedpyright not found. Installing..."
        python3 -m pip install --user basedpyright
    fi
    
    # run basedpyright checks  
    if [ -n "$PATH_TO_CHECK" ]; then
        echo "Running basedpyright on: $PATH_TO_CHECK"
        python3 -m basedpyright "$PATH_TO_CHECK"
    else
        echo "Running basedpyright on entire repository..."
        python3 -m basedpyright
    fi
fi